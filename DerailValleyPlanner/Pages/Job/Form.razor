@page "/job/create"
@page "/job/edit/{JobId:int}"

@using DerailValleyPlanner.Models
@using DerailValleyPlanner.Data
@using DerailValleyPlanner.Services
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.Logging

@inject ILogger<Form> Logger
@inject NavigationManager NavManager
@inject ConfigService Config

<EditForm Model="@_job" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator/>
    <MudGrid>
        <MudItem xs="12">
            <MudCard>
                <MudCardHeader>
                    <MudText Typo="Typo.h3" Align="Align.Center">
                        Add Job
                    </MudText>
                </MudCardHeader>
                <MudCardContent>
@if (!success)
{
                    <MudText Color="@Color.Error">
                        <ValidationSummary />
                    </MudText>
}
                    <MudTextField Label="Consist ID" @bind-Value="_job.ConsistId"></MudTextField>
                    <MudTextField Label="From Yard" @bind-Value="_job.FromYard"></MudTextField>
                    <MudTextField Label="From Track" @bind-Value="_job.FromTrack"></MudTextField>
                    <MudTextField Label="To Yard" @bind-Value="_job.ToYard"></MudTextField>
                    <MudTextField Label="To Track" @bind-Value="_job.ToTrack"></MudTextField>
                    <MudNumericField Label="Mass" @bind-Value="_job.Mass"></MudNumericField>
                    <MudNumericField Label="Length" @bind-Value="_job.Length"></MudNumericField>
                    <MudNumericField Label="Wagon Count" @bind-Value="_job.Wagons"></MudNumericField>
                    <MudNumericField Label="Pays" @bind-Value="_job.Pays"></MudNumericField>
                    <MudTextField Label="Description" @bind-Value="_job.Description"></MudTextField>
                </MudCardContent>
                <MudCardActions>
                    <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto">@(_create ? "Add" : "Update")</MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>
    </MudGrid>
</EditForm>

@code {
    [Parameter] public int? JobId { get; set; }
    
    bool success;
    private Job _job;
    private bool _create;

    [Inject]
    private PlannerContext Context { get; set; }
    
    
    protected override async Task OnInitializedAsync()
    {
        if (JobId == null)
        {
            _create = true;
            _job = new Job
            {
                ConsistId = "AA-BB-11",
                FromYard = "abcd",
                FromTrack = "abcd",
                ToYard = "abcd",
                ToTrack = "abcd",
                Mass = 10,
                Length = 10,
                Pays = 10,
                Wagons = 10,
                Description = "abcd"
            };
        }
        else
        {
            _create = false;
            _job = await Context.Jobs.FirstOrDefaultAsync(j => j.JobId == JobId);
        }
    }

    private async Task HandleValidSubmit()
    {
        Console.WriteLine("HI MOM!");
        Logger.LogInformation("Consist ID: {ConsistId}", _job.ConsistId);
        Logger.LogInformation("Config: {Config}", Config.GetType());
        
        // Config.Yards
        if (_create)
        {
            Context.Jobs.Add(_job);
        }
        else
        {
            Context.Jobs.Update(_job);
        }
        await Context.SaveChangesAsync();
        success = true;
        StateHasChanged();
        NavManager.NavigateTo("/job");
    }

}
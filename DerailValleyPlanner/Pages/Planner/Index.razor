@page "/planner"
@* @page "/planner/{EditMode}" *@

@using DerailValleyPlanner.Models
@using DerailValleyPlanner.Data
@using Microsoft.EntityFrameworkCore
@inject ISnackbar Snackbar
@*
- Will list all Yards and the summary for each (total jobs, wagons, length, mass and money totalled) load and unload
- Allows child component? Or mode that allows selecting a yard to add?
 *@
<MudText Typo="Typo.h3">Journey Planner</MudText>
<MudSwitch @bind-Checked="@ReadOnly">Edit Mode</MudSwitch>

<MudTable
    Items="@_stops"
    T="Stop"
    Dense="true"
    Hover="true"
    CanCancelEdit="true"
    ReadOnly="@(!ReadOnly)"
    @bind-SelectedItem="selectedItem"
    CommitEditTooltip="Commit Edit"
    OnCommitEditClick="@(() => Snackbar.Add("Commit Edit Handler Invoked"))"
    RowEditPreview="BackupItem"
    RowEditCancel="ResetItemToOriginalValues"
    RowEditCommit="ItemHasBeenCommitted"
    ApplyButtonPosition="@TableApplyButtonPosition.End"
    EditButtonPosition="@TableEditButtonPosition.End"
    EditTrigger="@TableEditTrigger.EditButton"
>
    <HeaderContent>
        @if (!ReadOnly)
        {
            <MudTh>Index</MudTh>
        }
        <MudTh>Yard</MudTh>
        <MudTh>Type</MudTh>
        <MudTh>Note</MudTh>
        <MudTh>Mass</MudTh>
        <MudTh>Length</MudTh>
        <MudTh>Wagons</MudTh>
        <MudTh>Pay</MudTh>
    </HeaderContent>
    <RowTemplate>
        @if (!ReadOnly)
        {
            <MudTd DataLabel="Index">@context.Index</MudTd>
        }
        <MudTd DataLabel="Yard">@context.Yard</MudTd>
        <MudTd DataLabel="Type">@context.Type</MudTd>
        <MudTd DataLabel="Note">@context.Note</MudTd>
        <MudTd DataLabel="TotalMass">@context.TotalMass</MudTd>
        <MudTd DataLabel="TotalLength">@context.TotalLength</MudTd>
        <MudTd DataLabel="TotalWagons">@context.TotalWagons</MudTd>
        <MudTd DataLabel="TotalPay">@context.TotalPay</MudTd>
    </RowTemplate>
    <RowEditingTemplate>
        <MudTd DataLabel="Index">
            <MudNumericField Label="Index" @bind-Value="@context.Index"></MudNumericField>
        </MudTd>
        <MudTd DataLabel="Yard">
            <YardSelection @bind-Yard="@context.Yard"></YardSelection>
        </MudTd>
        <MudTd DataLabel="Type">Dropdown</MudTd>
        <MudTd DataLabel="Note">Text box</MudTd>
    </RowEditingTemplate>
    <EditButtonContent Context="button">
        <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Edit" Class="pa-0" OnClick="@button.ButtonAction" Disabled="@button.ButtonDisabled" />
    </EditButtonContent>
</MudTable>

@code {
    
    [Inject]
    private PlannerContext PlannerContext { get; set; }
    
    // [Parameter] public string EditMode { get; set; }

    private bool ReadOnly = true;

    private Stop selectedItem;
    private Stop EditCache;
    private IndexedList<Stop> _stops;
    
    protected override async Task OnInitializedAsync()
    {
        await GetStops();
    }

    async Task GetStops()
    {
        var data = await PlannerContext.Stops.OrderBy(s => s.Index).ToListAsync();
        _stops = new IndexedList<Stop>(data);
    }

    private void BackupItem(object stopObj)
    {
        var stop = (Stop)stopObj;
        EditCache = new Stop
        {
            Index = stop.Index,
            StopId = stop.StopId,
            Type = stop.Type,
            Jobs = stop.Jobs,
            Yard = stop.Yard,
            Note = stop.Note
        };
        StateHasChanged();
    }

    private async void ItemHasBeenCommitted(object stopObj)
    {
        var oldStop = EditCache;
        var newStop = (Stop)stopObj;

        if (oldStop.Index != newStop.Index)
        {
            _stops.Move(oldStop.Index, newStop.Index);
            _stops.ActionOnUpdatedIndex(s =>
            {
                PlannerContext.Stops.Update(s);
            });
        }
        else
        {
            PlannerContext.Stops.Update(newStop);
        }
        
        await PlannerContext.SaveChangesAsync();
        
        StateHasChanged();
    }

    private void ResetItemToOriginalValues(object stopObj)
    {
        var stop = (Stop)stopObj;
        stop.Index = EditCache.Index;
        stop.StopId = EditCache.StopId;
        stop.Type = EditCache.Type;
        stop.Jobs = EditCache.Jobs;
        stop.Yard = EditCache.Yard;
        stop.Note = EditCache.Note;
        StateHasChanged();
    }
    
    
}